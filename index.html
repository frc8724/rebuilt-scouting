<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rebuilt Scouting (Offline)</title>
  <style>
    :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b0f19; color: #e8eefc; }
    header {
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      position: sticky; top: 0; background: #0b0f19; z-index: 5;
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
    h1 { font-size: 16px; margin: 0 0 6px; }
    .sub { font-size: 12px; opacity: 0.75; }
    main { padding: 12px; max-width: 1060px; margin: 0 auto; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 980px) { .grid { grid-template-columns: 1fr 1fr; } }

    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); border-radius: 12px; padding: 12px; }
    .card h2 { font-size: 14px; margin: 0 0 8px; }
    .muted { opacity: 0.8; }
    .small { font-size: 12px; opacity: 0.85; }

    label { display: block; font-size: 12px; opacity: 0.9; margin: 10px 0 4px; }
    input, select, textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(0,0,0,0.25);
      color: #e8eefc;
      outline: none;
      font-size: 16px; /* prevents iOS zoom */
    }
    textarea { min-height: 84px; resize: vertical; }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    @media (max-width: 600px) { .row, .row3 { grid-template-columns: 1fr; } }

    .btnrow { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button {
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      color: #e8eefc;
      font-size: 16px;
      cursor: pointer;
    }
    button.primary { background: #2b6cff; border-color: rgba(255,255,255,0.25); }
    button.danger { background: rgba(255,80,80,0.25); }
    button:active { transform: translateY(1px); }

    .stepbar { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
    .dot { width: 10px; height: 10px; border-radius: 999px; background: rgba(255,255,255,0.18); }
    .dot.on { background: #2b6cff; }
    .stepname { font-size: 12px; opacity: 0.85; margin-left: 6px; }

    .hidden { display:none !important; }

    .counterWrap { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 600px) { .counterWrap { grid-template-columns: 1fr; } }
    .counterCard {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 12px;
      padding: 12px;
    }
    .bigNum { font-size: 44px; line-height: 1.05; font-weight: 700; letter-spacing: 0.5px; }
    .btnGrid { display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .btnGrid button { flex: 1 1 120px; }
    .btnGrid .smallBtn { flex: 1 1 90px; opacity: 0.95; }
    .btnGrid .dangerBtn { background: rgba(255,80,80,0.22); border-color: rgba(255,255,255,0.18); }
    .btnGrid .resetBtn { background: rgba(255,255,255,0.08); opacity: 0.9; }

    .table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .table th, .table td { border-bottom: 1px solid rgba(255,255,255,0.10); padding: 8px 6px; vertical-align: top; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; background: rgba(255,255,255,0.10); font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    /* Simple modal */
    .modalBackdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.75);
      z-index: 9999;
      padding: 16px;
    }
    .modalPanel {
      max-width: 720px;
      margin: 20px auto;
      background: #0b0f19;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      padding: 14px;
    }
    .modalHeader {
      display: flex; justify-content: space-between; align-items: center; gap: 10px;
    }
  </style>
</head>

<body>
<header>
  <div>
    <h1>Rebuilt Scouting (Offline)</h1>
    <div class="sub">Wizard flow • Tap counters • Offline storage • CSV + QR transfer</div>
  </div>
  <div class="stepbar" id="stepbar"></div>
</header>

<main class="grid">
  <!-- Wizard -->
  <section class="card">
    <h2 id="stepTitle">Setup</h2>
    <div class="small muted" id="stepHint">Enter match + team once, then follow phases.</div>

    <!-- Setup -->
    <div class="step" id="step-setup">
      <div class="row">
        <div>
          <label>Scout Name</label>
          <input id="scoutName" placeholder="e.g., Alex" />
        </div>
        <div>
          <label>Event / Session</label>
          <input id="eventName" placeholder="e.g., Week 0 Scrimmage" />
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Match #</label>
          <input id="matchNum" inputmode="numeric" placeholder="e.g., 12" />
        </div>
        <div>
          <label>Robot Team #</label>
          <input id="teamNum" inputmode="numeric" placeholder="e.g., 8724" />
        </div>
        <div>
          <label>Alliance</label>
          <select id="alliance">
            <option value="Red">Red</option>
            <option value="Blue">Blue</option>
          </select>
        </div>
      </div>

      <div class="btnrow">
        <button class="primary" id="startMatchBtn">Start → Auto</button>
        <button id="resetDraftBtn">Reset This Entry</button>
      </div>
      <div class="small muted">Tip: Add to Home Screen on iPad Safari for “app mode”.</div>
    </div>

    <!-- Auto -->
    <div class="step hidden" id="step-auto">
      <div class="counterWrap">
        <div class="counterCard">
          <div class="small muted">Auto Fuel</div>
          <div class="bigNum" id="autoFuelNum">0</div>
          <div class="btnGrid">
            <button class="primary" id="autoPlus5">+5</button>
            <button class="primary" id="autoPlus1">+1</button>
            <button class="dangerBtn" id="autoMinus1">-1</button>
            <button class="resetBtn smallBtn" id="autoReset">Reset</button>
          </div>
        </div>

        <div class="counterCard">
          <label>Won Auto? (fuel only)</label>
          <select id="autoWin">
            <option value="Unknown">Unknown</option>
            <option value="Won">Won</option>
            <option value="Lost">Lost</option>
            <option value="Tied">Tied</option>
          </select>

          <label>Auto End Position</label>
          <select id="autoEndPos">
            <option value="NZ">Neutral Zone</option>
            <option value="AZ">Alliance Zone</option>
            <option value="Near Hub">Near Hub</option>
            <option value="Near Tower">Near Tower</option>
            <option value="Other/Unknown">Other/Unknown</option>
          </select>

          <label>Auto Action</label>
          <select id="autoAction">
            <option value="None">None</option>
            <option value="Low Climb">Low Climb</option>
          </select>
        </div>
      </div>

      <div class="btnrow">
        <button id="backToSetupBtn">← Back</button>
        <button class="primary" id="toActive1Btn">Next → Active 1</button>
      </div>
    </div>

    <!-- Active 1 -->
    <div class="step hidden" id="step-active1">
      <div class="counterWrap">
        <div class="counterCard">
          <div class="small muted">Active 1 Fuel</div>
          <div class="bigNum" id="a1FuelNum">0</div>
          <div class="btnGrid">
            <button class="primary" id="a1Plus5">+5</button>
            <button class="primary" id="a1Plus1">+1</button>
            <button class="dangerBtn" id="a1Minus1">-1</button>
            <button class="resetBtn smallBtn" id="a1Reset">Reset</button>
          </div>
        </div>

        <div class="counterCard">
          <div class="small muted">Active 1 Cycles</div>
          <div class="bigNum" id="a1CyclesNum">0</div>
          <div class="btnGrid">
            <button class="primary" id="a1CycPlus">+1 Cycle</button>
            <button class="dangerBtn" id="a1CycMinus">-1 Cycle</button>
            <button class="resetBtn smallBtn" id="a1CycReset">Reset</button>
          </div>
          <div class="small muted">
            Cycle = intake → score → disengage (don’t count partial dumps as new cycles).
          </div>
        </div>
      </div>

      <div class="btnrow">
        <button id="backToAutoBtn">← Back</button>
        <button class="primary" id="toInactive1Btn">Next → Inactive 1</button>
      </div>
    </div>

    <!-- Inactive 1 -->
    <div class="step hidden" id="step-inactive1">
      <div class="row3">
        <div>
          <label>Inactive 1: Primary Action</label>
          <select id="i1Action">
            <option value="Unknown">Unknown</option>
            <option value="Hoarded">Hoarded</option>
            <option value="Defense">Defense</option>
            <option value="Both">Both</option>
            <option value="Neither">Neither</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div>
          <label>Inactive 1: End Position</label>
          <select id="i1EndPos">
            <option value="Unknown">Unknown</option>
            <option value="AZ">AZ</option>
            <option value="NZ">NZ</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div>
          <label>Inactive 1: Ready to Shoot?</label>
          <select id="i1Ready">
            <option value="Unknown">Unknown</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>
      </div>

      <div class="btnrow">
        <button id="backToActive1Btn">← Back</button>
        <button class="primary" id="toActive2Btn">Next → Active 2</button>
      </div>
    </div>

    <!-- Active 2 -->
    <div class="step hidden" id="step-active2">
      <div class="counterWrap">
        <div class="counterCard">
          <div class="small muted">Active 2 Fuel</div>
          <div class="bigNum" id="a2FuelNum">0</div>
          <div class="btnGrid">
            <button class="primary" id="a2Plus5">+5</button>
            <button class="primary" id="a2Plus1">+1</button>
            <button class="dangerBtn" id="a2Minus1">-1</button>
            <button class="resetBtn smallBtn" id="a2Reset">Reset</button>
          </div>
        </div>

        <div class="counterCard">
          <div class="small muted">Active 2 Cycles</div>
          <div class="bigNum" id="a2CyclesNum">0</div>
          <div class="btnGrid">
            <button class="primary" id="a2CycPlus">+1 Cycle</button>
            <button class="dangerBtn" id="a2CycMinus">-1 Cycle</button>
            <button class="resetBtn smallBtn" id="a2CycReset">Reset</button>
          </div>
        </div>
      </div>

      <div class="btnrow">
        <button id="backToInactive1Btn">← Back</button>
        <button class="primary" id="toInactive2Btn">Next → Inactive 2</button>
      </div>
    </div>

    <!-- Inactive 2 -->
    <div class="step hidden" id="step-inactive2">
      <div class="row3">
        <div>
          <label>Inactive 2: Primary Action</label>
          <select id="i2Action">
            <option value="Unknown">Unknown</option>
            <option value="Hoarded">Hoarded</option>
            <option value="Defense">Defense</option>
            <option value="Both">Both</option>
            <option value="Neither">Neither</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div>
          <label>Inactive 2: End Position</label>
          <select id="i2EndPos">
            <option value="Unknown">Unknown</option>
            <option value="AZ">AZ</option>
            <option value="NZ">NZ</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div>
          <label>Inactive 2: Ready to Shoot?</label>
          <select id="i2Ready">
            <option value="Unknown">Unknown</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>
      </div>

      <div class="btnrow">
        <button id="backToActive2Btn">← Back</button>
        <button class="primary" id="toSharedBtn">Next → Shared Active</button>
      </div>
    </div>

    <!-- Shared Active -->
    <div class="step hidden" id="step-shared">
      <div class="counterWrap">
        <div class="counterCard">
          <div class="small muted">Shared Active Fuel</div>
          <div class="bigNum" id="sFuelNum">0</div>
          <div class="btnGrid">
            <button class="primary" id="sPlus5">+5</button>
            <button class="primary" id="sPlus1">+1</button>
            <button class="dangerBtn" id="sMinus1">-1</button>
            <button class="resetBtn smallBtn" id="sReset">Reset</button>
          </div>
        </div>

        <div class="counterCard">
          <div class="small muted">Shared Active Cycles</div>
          <div class="bigNum" id="sCyclesNum">0</div>
          <div class="btnGrid">
            <button class="primary" id="sCycPlus">+1 Cycle</button>
            <button class="dangerBtn" id="sCycMinus">-1 Cycle</button>
            <button class="resetBtn smallBtn" id="sCycReset">Reset</button>
          </div>
        </div>
      </div>

      <div class="btnrow">
        <button id="backToInactive2Btn">← Back</button>
        <button class="primary" id="toEndgameBtn">Next → Endgame</button>
      </div>
    </div>

    <!-- Endgame -->
    <div class="step hidden" id="step-endgame">
      <div class="row3">
        <div>
          <label>Endgame Action</label>
          <select id="endAction">
            <option value="None">None</option>
            <option value="Continued Shooting">Continued Shooting</option>
            <option value="Low Climb">Low Climb</option>
            <option value="Mid Climb">Mid Climb</option>
            <option value="High Climb">High Climb</option>
          </select>
        </div>
        <div>
          <label>Endgame Result</label>
          <select id="endSuccess">
            <option value="N/A">N/A</option>
            <option value="Success">Success</option>
            <option value="Fail">Fail</option>
          </select>
        </div>
        <div>
          <label>Defense Applicable?</label>
          <select id="defApplicable">
            <option value="Unknown">Unknown</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Defense Impact (1–5)</label>
          <select id="defenseRating">
            <option value="0">0 (N/A)</option>
            <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option>
          </select>
        </div>
        <div>
          <label>Driver Competency (1–5)</label>
          <select id="driverRating">
            <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option>
          </select>
        </div>
        <div>
          <label>Robot Capability (1–5)</label>
          <select id="robotRating">
            <option value="1">1</option><option value="2">2</option><option value="3" selected>3</option><option value="4">4</option><option value="5">5</option>
          </select>
        </div>
      </div>

      <label>Notes (keep short — QR has size limits)</label>
      <textarea id="notes" placeholder="Examples: ‘great hoard’; ‘defense slowed cycles’; ‘climb shaky’; ‘jam once’"></textarea>

      <div class="btnrow">
        <button id="backToSharedBtn">← Back</button>
        <button class="primary" id="finishSaveBtn">Finish & Save</button>
        <button id="cancelMatchBtn">Cancel Entry</button>
      </div>
      <div class="small muted">Saved records persist offline on this device.</div>
    </div>
  </section>

  <!-- Saved Records -->
  <section class="card">
    <h2>Saved Observations</h2>
    <div class="btnrow" style="margin-bottom:10px;">
      <button id="exportBtn">Export CSV</button>
      <button id="copyCsvBtn">Copy CSV</button>
      <button id="importBtn">Import CSV (Merge)</button>
      <button id="showQrBtn">Show QR (Last Saved)</button>
      <button id="scanQrBtn">Scan QR (Import)</button>
      <button class="danger" id="deleteAllBtn">Delete All (This Device)</button>
    </div>

    <div class="small muted">
      QR workflow: each scout saves → shows QR → master scans/imports → master exports one CSV later.
    </div>

    <div style="margin-top:10px; overflow:auto; max-height: 58vh;">
      <table class="table">
        <thead>
          <tr>
            <th>Key</th>
            <th>Match</th>
            <th>Team</th>
            <th>Auto</th>
            <th>Active</th>
            <th>Inactive</th>
            <th>Endgame</th>
            <th>Totals</th>
            <th>Notes</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="small muted" style="margin-top:10px;">
      Storage is local. Export often.
    </div>
  </section>
</main>

<input type="file" id="fileInput" accept=".csv,text/csv" style="display:none" />

<!-- QR SHOW MODAL -->
<div id="qrModal" class="modalBackdrop hidden" aria-hidden="true">
  <div class="modalPanel">
    <div class="modalHeader">
      <div>
        <div style="font-weight:700;">Show QR (Last Saved Match)</div>
        <div class="small muted" id="qrMeta"></div>
      </div>
      <button id="qrCloseBtn">Close</button>
    </div>
    <div style="margin-top:12px; display:flex; justify-content:center;">
      <div id="qrBox" style="padding:12px; background:white; border-radius:12px;"></div>
    </div>
    <div class="small muted" style="margin-top:10px;">
      Scan this with the Master device → “Scan QR (Import)”.
    </div>
  </div>
</div>

<!-- QR SCAN MODAL -->
<div id="scanModal" class="modalBackdrop hidden" aria-hidden="true">
  <div class="modalPanel">
    <div class="modalHeader">
      <div>
        <div style="font-weight:700;">Scan QR (Import)</div>
        <div class="small muted">Point camera at a scout’s QR to import one match record.</div>
      </div>
      <button id="scanCloseBtn">Close</button>
    </div>
    <div id="reader" style="margin-top:12px;"></div>
    <div class="small muted" id="scanStatus" style="margin-top:10px;"></div>
  </div>
</div>

<!-- QR libraries (must exist in repo root for offline use) -->
<script src="./qrcode.min.js"></script>
<script src="./html5-qrcode.min.js"></script>

<script>
  // ===== Storage =====
  const STORAGE_KEY = "rebuilt_scout_v4";
  let records = [];
  let lastSavedRecord = null;

  function uid() {
    return (Date.now().toString(36) + "-" + Math.random().toString(36).slice(2, 8)).toUpperCase();
  }

  function load() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      records = raw ? JSON.parse(raw) : [];
    } catch { records = []; }
    renderTable();
  }

  function persist() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    renderTable();
  }

  // ===== Wizard Steps =====
  const STEPS = [
    { id: "setup", title: "Setup", hint: "Enter match + team once, then follow phases." },
    { id: "auto", title: "Auto", hint: "Tap fuel counters and select auto outcomes." },
    { id: "active1", title: "Active 1", hint: "Tap fuel and cycles as they happen." },
    { id: "inactive1", title: "Inactive 1", hint: "Log hoard/defense intent + end position + ready." },
    { id: "active2", title: "Active 2", hint: "Tap fuel and cycles as they happen." },
    { id: "inactive2", title: "Inactive 2", hint: "Log hoard/defense intent + end position + ready." },
    { id: "shared", title: "Shared Active", hint: "Tap fuel and cycles as they happen." },
    { id: "endgame", title: "Endgame", hint: "Record end action + ratings + notes. Save." }
  ];

  let stepIndex = 0;
  let draft = {};
  let html5Qr = null;

  const $ = (id) => document.getElementById(id);

  function showStep(idx) {
    stepIndex = idx;
    const step = STEPS[idx];
    $("stepTitle").textContent = step.title;
    $("stepHint").textContent = step.hint;

    // step dots
    const bar = $("stepbar");
    bar.innerHTML = "";
    STEPS.forEach((_, i) => {
      const d = document.createElement("div");
      d.className = "dot" + (i === idx ? " on" : "");
      bar.appendChild(d);
    });
    const name = document.createElement("div");
    name.className = "stepname";
    name.textContent = step.title;
    bar.appendChild(name);

    // hide all, show one
    document.querySelectorAll(".step").forEach(el => el.classList.add("hidden"));
    $("step-" + step.id).classList.remove("hidden");
  }

  function numFromEl(id) { return Number($(id).textContent || "0"); }
  function setNumEl(id, n) { $(id).textContent = String(Math.max(0, Number(n)||0)); }
  function addToEl(id, delta) { setNumEl(id, numFromEl(id) + delta); }

  function resetActiveCounters(which) {
    if (which === "a1") { setNumEl("a1FuelNum",0); setNumEl("a1CyclesNum",0); }
    if (which === "a2") { setNumEl("a2FuelNum",0); setNumEl("a2CyclesNum",0); }
    if (which === "s")  { setNumEl("sFuelNum",0);  setNumEl("sCyclesNum",0); }
  }

  function resetDraft(keepScoutEvent=true) {
    const scout = $("scoutName").value;
    const event = $("eventName").value;

    draft = { key: uid(), ts: new Date().toISOString() };

    if (!keepScoutEvent) { $("scoutName").value = ""; $("eventName").value = ""; }
    $("matchNum").value = ""; $("teamNum").value = ""; $("alliance").value = "Red";

    $("autoWin").value = "Unknown";
    $("autoEndPos").value = "NZ";
    $("autoAction").value = "None";
    setNumEl("autoFuelNum", 0);

    resetActiveCounters("a1");
    resetActiveCounters("a2");
    resetActiveCounters("s");

    $("i1Action").value = "Unknown"; $("i1EndPos").value = "Unknown"; $("i1Ready").value = "Unknown";
    $("i2Action").value = "Unknown"; $("i2EndPos").value = "Unknown"; $("i2Ready").value = "Unknown";

    $("endAction").value = "None";
    $("endSuccess").value = "N/A";
    $("defApplicable").value = "Unknown";
    $("defenseRating").value = "3";
    $("driverRating").value = "3";
    $("robotRating").value = "3";
    $("notes").value = "";

    $("scoutName").value = scout;
    $("eventName").value = event;

    showStep(0);
  }

  function validateSetup() {
    const matchNum = $("matchNum").value.trim();
    const teamNum = $("teamNum").value.trim();
    if (!matchNum || !teamNum) return "Match # and Team # are required.";
    if (!/^\d+$/.test(matchNum)) return "Match # must be numeric.";
    if (!/^\d+$/.test(teamNum)) return "Team # must be numeric.";
    return null;
  }

  // ===== Wizard wiring =====
  $("startMatchBtn").addEventListener("click", () => {
    const err = validateSetup();
    if (err) return alert(err);

    draft.scoutName = $("scoutName").value.trim();
    draft.eventName = $("eventName").value.trim();
    draft.matchNum = Number($("matchNum").value.trim());
    draft.teamNum  = Number($("teamNum").value.trim());
    draft.alliance = $("alliance").value;

    showStep(1);
  });

  $("resetDraftBtn").addEventListener("click", () => {
    if (!confirm("Reset this current entry? (Saved records unaffected)")) return;
    resetDraft(true);
  });

  $("cancelMatchBtn").addEventListener("click", () => {
    if (!confirm("Cancel this entry? Nothing will be saved.")) return;
    resetDraft(true);
  });

  // Back buttons
  $("backToSetupBtn").addEventListener("click", () => showStep(0));
  $("backToAutoBtn").addEventListener("click", () => showStep(1));
  $("backToActive1Btn").addEventListener("click", () => showStep(2));
  $("backToInactive1Btn").addEventListener("click", () => showStep(3));
  $("backToActive2Btn").addEventListener("click", () => showStep(4));
  $("backToInactive2Btn").addEventListener("click", () => showStep(5));
  $("backToSharedBtn").addEventListener("click", () => showStep(6));

  // Auto counter buttons
  $("autoPlus5").addEventListener("click", () => addToEl("autoFuelNum", 5));
  $("autoPlus1").addEventListener("click", () => addToEl("autoFuelNum", 1));
  $("autoMinus1").addEventListener("click", () => addToEl("autoFuelNum", -1));
  $("autoReset").addEventListener("click", () => setNumEl("autoFuelNum", 0));

  // Active 1 counters
  $("a1Plus5").addEventListener("click", () => addToEl("a1FuelNum", 5));
  $("a1Plus1").addEventListener("click", () => addToEl("a1FuelNum", 1));
  $("a1Minus1").addEventListener("click", () => addToEl("a1FuelNum", -1));
  $("a1Reset").addEventListener("click", () => setNumEl("a1FuelNum", 0));
  $("a1CycPlus").addEventListener("click", () => addToEl("a1CyclesNum", 1));
  $("a1CycMinus").addEventListener("click", () => addToEl("a1CyclesNum", -1));
  $("a1CycReset").addEventListener("click", () => setNumEl("a1CyclesNum", 0));

  // Active 2 counters
  $("a2Plus5").addEventListener("click", () => addToEl("a2FuelNum", 5));
  $("a2Plus1").addEventListener("click", () => addToEl("a2FuelNum", 1));
  $("a2Minus1").addEventListener("click", () => addToEl("a2FuelNum", -1));
  $("a2Reset").addEventListener("click", () => setNumEl("a2FuelNum", 0));
  $("a2CycPlus").addEventListener("click", () => addToEl("a2CyclesNum", 1));
  $("a2CycMinus").addEventListener("click", () => addToEl("a2CyclesNum", -1));
  $("a2CycReset").addEventListener("click", () => setNumEl("a2CyclesNum", 0));

  // Shared counters
  $("sPlus5").addEventListener("click", () => addToEl("sFuelNum", 5));
  $("sPlus1").addEventListener("click", () => addToEl("sFuelNum", 1));
  $("sMinus1").addEventListener("click", () => addToEl("sFuelNum", -1));
  $("sReset").addEventListener("click", () => setNumEl("sFuelNum", 0));
  $("sCycPlus").addEventListener("click", () => addToEl("sCyclesNum", 1));
  $("sCycMinus").addEventListener("click", () => addToEl("sCyclesNum", -1));
  $("sCycReset").addEventListener("click", () => setNumEl("sCyclesNum", 0));

  // Next buttons (auto-reset between actives)
  $("toActive1Btn").addEventListener("click", () => {
    draft.autoFuel = numFromEl("autoFuelNum");
    draft.autoWin = $("autoWin").value;
    draft.autoEndPos = $("autoEndPos").value;
    draft.autoAction = $("autoAction").value;

    resetActiveCounters("a1");
    showStep(2);
  });

  $("toInactive1Btn").addEventListener("click", () => {
    draft.a1Fuel = numFromEl("a1FuelNum");
    draft.a1Cycles = numFromEl("a1CyclesNum");
    showStep(3);
  });

  $("toActive2Btn").addEventListener("click", () => {
    draft.i1Action = $("i1Action").value;
    draft.i1EndPos = $("i1EndPos").value;
    draft.i1Ready = $("i1Ready").value;

    resetActiveCounters("a2");
    showStep(4);
  });

  $("toInactive2Btn").addEventListener("click", () => {
    draft.a2Fuel = numFromEl("a2FuelNum");
    draft.a2Cycles = numFromEl("a2CyclesNum");
    showStep(5);
  });

  $("toSharedBtn").addEventListener("click", () => {
    draft.i2Action = $("i2Action").value;
    draft.i2EndPos = $("i2EndPos").value;
    draft.i2Ready = $("i2Ready").value;

    resetActiveCounters("s");
    showStep(6);
  });

  $("toEndgameBtn").addEventListener("click", () => {
    draft.sFuel = numFromEl("sFuelNum");
    draft.sCycles = numFromEl("sCyclesNum");
    showStep(7);
  });

  // Save
  $("finishSaveBtn").addEventListener("click", () => {
    draft.endAction = $("endAction").value;
    draft.endSuccess = $("endSuccess").value;
    draft.defApplicable = $("defApplicable").value;
    draft.defenseRating = Number($("defenseRating").value || "0");
    draft.driverRating = Number($("driverRating").value || "0");
    draft.robotRating = Number($("robotRating").value || "0");
    draft.notes = $("notes").value.trim();
    draft.ts = new Date().toISOString();

    // derived totals
    draft.totalFuelTeleop = (Number(draft.a1Fuel)||0) + (Number(draft.a2Fuel)||0) + (Number(draft.sFuel)||0);
    draft.totalFuelAll = (Number(draft.autoFuel)||0) + draft.totalFuelTeleop;
    draft.totalCyclesTeleop = (Number(draft.a1Cycles)||0) + (Number(draft.a2Cycles)||0) + (Number(draft.sCycles)||0);

    records.unshift(draft);
    lastSavedRecord = draft; // used for QR show
    persist();
    resetDraft(true);
    alert("Saved!");
  });

  // ===== Table =====
  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function renderTable() {
    const tbody = $("tbody");
    tbody.innerHTML = "";
    for (const r of records.slice(0, 300)) {
      const tr = document.createElement("tr");
      const autoStr = `${r.autoFuel ?? 0} fuel • ${r.autoWin ?? ""}<br><span class="muted">${escapeHtml(r.autoEndPos ?? "")} • ${escapeHtml(r.autoAction ?? "")}</span>`;
      const activeStr =
        `A1: ${r.a1Cycles ?? 0} cyc / ${r.a1Fuel ?? 0} fuel<br>` +
        `A2: ${r.a2Cycles ?? 0} cyc / ${r.a2Fuel ?? 0} fuel<br>` +
        `Sh: ${r.sCycles ?? 0} cyc / ${r.sFuel ?? 0} fuel`;
      const inactiveStr =
        `I1: ${escapeHtml(r.i1Action ?? "")} • end:${escapeHtml(r.i1EndPos ?? "")} • ready:${escapeHtml(r.i1Ready ?? "")}<br>` +
        `I2: ${escapeHtml(r.i2Action ?? "")} • end:${escapeHtml(r.i2EndPos ?? "")} • ready:${escapeHtml(r.i2Ready ?? "")}`;
      const endStr =
        `${escapeHtml(r.endAction ?? "")} • ${escapeHtml(r.endSuccess ?? "")}<br>` +
        `<span class="muted">Def:${r.defenseRating ?? ""} • Driver:${r.driverRating ?? ""} • Robot:${r.robotRating ?? ""}</span>`;
      const totalsStr =
        `Teleop fuel: ${r.totalFuelTeleop ?? ""}<br>` +
        `All fuel: ${r.totalFuelAll ?? ""}<br>` +
        `<span class="muted">Teleop cycles: ${r.totalCyclesTeleop ?? ""}</span>`;

      tr.innerHTML = `
        <td class="mono">${escapeHtml(r.key)}</td>
        <td>${escapeHtml(r.matchNum)}<br><span class="pill">${escapeHtml(r.alliance)}</span></td>
        <td>${escapeHtml(r.teamNum)}</td>
        <td>${autoStr}</td>
        <td>${activeStr}</td>
        <td>${inactiveStr}</td>
        <td>${endStr}</td>
        <td>${totalsStr}</td>
        <td>${escapeHtml((r.notes||"").slice(0,120))}${(r.notes||"").length>120?"…":""}</td>
        <td><button data-del="${escapeHtml(r.key)}">Del</button></td>
      `;
      tbody.appendChild(tr);
    }

    tbody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const k = btn.getAttribute("data-del");
        records = records.filter(x => x.key !== k);
        persist();
      });
    });
  }

  // ===== CSV =====
  const CSV_HEADERS = [
    "key","ts","scoutName","eventName","matchNum","teamNum","alliance",
    "autoFuel","autoWin","autoEndPos","autoAction",
    "a1Fuel","a1Cycles","i1Action","i1EndPos","i1Ready",
    "a2Fuel","a2Cycles","i2Action","i2EndPos","i2Ready",
    "sFuel","sCycles",
    "endAction","endSuccess","defApplicable","defenseRating","driverRating","robotRating",
    "totalFuelTeleop","totalFuelAll","totalCyclesTeleop",
    "notes"
  ];

  function toCsvValue(val) {
    const s = (val === null || val === undefined) ? "" : String(val);
    if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }

  function exportCSVText() {
    const lines = [];
    lines.push(CSV_HEADERS.join(","));
    for (const r of records) {
      const row = CSV_HEADERS.map(h => toCsvValue(r[h]));
      lines.push(row.join(","));
    }
    return lines.join("\n");
  }

  function download(filename, text) {
    const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  $("exportBtn").addEventListener("click", () => {
    const name = ($("eventName").value.trim() || "rebuilt").replace(/[^\w\-]+/g,"_").slice(0,40);
    download(`${name}_scouting_${new Date().toISOString().slice(0,10)}.csv`, exportCSVText());
  });

  $("copyCsvBtn").addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(exportCSVText());
      alert("CSV copied. Paste into Sheets/Excel later.");
    } catch {
      alert("Clipboard copy failed. Use Export CSV instead.");
    }
  });

  $("importBtn").addEventListener("click", () => $("fileInput").click());

  $("fileInput").addEventListener("change", async (ev) => {
    const file = ev.target.files && ev.target.files[0];
    if (!file) return;
    const text = await file.text();
    const imported = parseCSV(text);
    if (!imported.length) return alert("No records found in CSV.");

    const existingKeys = new Set(records.map(r => r.key));
    let added = 0;
    for (const r of imported) {
      if (!r.key || existingKeys.has(r.key)) continue;
      records.push(r);
      existingKeys.add(r.key);
      added++;
    }
    records.sort((a,b) => (a.ts < b.ts ? 1 : -1));
    persist();
    alert(`Imported ${imported.length} rows, added ${added} new.`);
    ev.target.value = "";
  });

  function parseCSV(text) {
    const rows = [];
    let i = 0, field = "", row = [], inQuotes = false;

    function pushField(){ row.push(field); field=""; }
    function pushRow(){ rows.push(row); row=[]; }

    while (i < text.length) {
      const ch = text[i];
      if (inQuotes) {
        if (ch === '"') {
          if (text[i+1] === '"') { field += '"'; i += 2; continue; }
          inQuotes = false; i++; continue;
        } else { field += ch; i++; continue; }
      } else {
        if (ch === '"') { inQuotes = true; i++; continue; }
        if (ch === ",") { pushField(); i++; continue; }
        if (ch === "\n") { pushField(); pushRow(); i++; continue; }
        if (ch === "\r") { i++; continue; }
        field += ch; i++; continue;
      }
    }
    pushField();
    if (row.length > 1 || row[0] !== "") pushRow();

    if (!rows.length) return [];
    const headers = rows[0].map(h => h.trim());
    const out = [];
    for (const r of rows.slice(1)) {
      const obj = {};
      for (let c=0; c<headers.length; c++) obj[headers[c]] = r[c] ?? "";

      const nums = ["matchNum","teamNum","autoFuel","a1Fuel","a1Cycles","a2Fuel","a2Cycles","sFuel","sCycles",
                    "defenseRating","driverRating","robotRating","totalFuelTeleop","totalFuelAll","totalCyclesTeleop"];
      nums.forEach(k => obj[k] = Number(obj[k] || "0"));

      out.push(obj);
    }
    return out;
  }

  $("deleteAllBtn").addEventListener("click", () => {
    if (!confirm("Delete ALL scouting data on this device? (Export first!)")) return;
    records = [];
    persist();
  });

  // ===== QR Transfer (per-match) =====
  function closeQrModal() {
    $("qrModal").classList.add("hidden");
    $("qrBox").innerHTML = "";
  }

  function openQrModalForLast() {
    if (!lastSavedRecord) {
      alert("No saved match yet on this device.");
      return;
    }
    if (typeof QRCode === "undefined") {
      alert("QR library missing. Ensure qrcode.min.js is in the same folder as index.html.");
      return;
    }

    const payloadObj = { t: "rebuilt_scout_record", v: 1, record: lastSavedRecord };
    const payload = JSON.stringify(payloadObj);

    // Practical limit: keep this small for reliable scans
    if (payload.length > 2200) {
      alert("Record too large for a reliable single QR. Shorten notes and try again.");
      return;
    }

    $("qrMeta").textContent = `Match ${lastSavedRecord.matchNum} • Team ${lastSavedRecord.teamNum} • Key ${lastSavedRecord.key}`;
    $("qrBox").innerHTML = "";

    // Generate QR
    new QRCode($("qrBox"), {
      text: payload,
      width: 320,
      height: 320,
      correctLevel: QRCode.CorrectLevel.M
    });

    $("qrModal").classList.remove("hidden");
  }

  async function closeScanModal() {
    try {
      if (html5Qr) {
        await html5Qr.stop();
        await html5Qr.clear();
      }
    } catch (_) {}
    html5Qr = null;

    $("scanModal").classList.add("hidden");
    $("scanStatus").textContent = "";
    $("reader").innerHTML = "";
  }

  function tryImportQrPayload(text) {
    let obj;
    try {
      obj = JSON.parse(text);
    } catch {
      alert("QR did not contain valid JSON.");
      return;
    }

    if (!obj || obj.t !== "rebuilt_scout_record" || !obj.record || !obj.record.key) {
      alert("QR is not a valid Rebuilt scouting record.");
      return;
    }

    const rec = obj.record;

    // Merge by key
    if (records.some(r => r.key === rec.key)) {
      alert("Record already exists (duplicate).");
      return;
    }

    records.unshift(rec);
    persist();
    alert(`Imported: Match ${rec.matchNum} • Team ${rec.teamNum}`);
  }

  async function openScanModal() {
    if (typeof Html5Qrcode === "undefined") {
      alert("Scanner library missing. Ensure html5-qrcode.min.js is in the same folder as index.html.");
      return;
    }

    $("scanModal").classList.remove("hidden");
    $("scanStatus").textContent = "Starting camera…";

    // Create scanner
    html5Qr = new Html5Qrcode("reader");
    try {
      await html5Qr.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 260 },
        (decodedText) => {
          tryImportQrPayload(decodedText);
          closeScanModal();
        },
        () => {}
      );
      $("scanStatus").textContent = "Scanning…";
    } catch (e) {
      console.error(e);
      $("scanStatus").textContent = "Camera failed to start. Check permissions (HTTPS + allow camera).";
    }
  }

  $("showQrBtn").addEventListener("click", openQrModalForLast);
  $("scanQrBtn").addEventListener("click", openScanModal);
  $("qrCloseBtn").addEventListener("click", closeQrModal);
  $("scanCloseBtn").addEventListener("click", closeScanModal);

  // Init
  load();
  resetDraft(true);
</script>
</body>
</html>
